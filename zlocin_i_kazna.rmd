---
title: "Zločin i kazna - analiza kriminala"
author: Luka Mucko, Filip Pankretić, Matej Lopotar, Tomislav Žiger
output: html_document
---
## Motivacija i opis problema
Recidivizam je jedan od temeljnih pojmova u kaznenom pravosudu koji se odnosi na kriminalno ponašanje
nakon što je osoba već kažnjena zbog prethodnog. Recidivizmom se smatra ponavljanje bilo kakvog kaznenog
djela koje rezultira ponovnim uhićenjem ili ponovnom osudom tijekom razdoblja od tri godine nakon puštanja
osobe na slobodu. Zbog opće sigurnosti, a i razvoja novih strategija za reintegraciju (bivših) osuđenika, bitno
je proučiti i razumjeti koji čimbenici su učestaliji kod ponavljača zločina.
<br>
**Prvo ćemo odgovoriti na zadana pitanja, zatim ispitivati vlastite hipoteze.** <br>
Učitajmo podatke:

```{r warning = FALSE}
recidivism_full <- read.csv("recidivism_full.csv")
```
```{r include = FALSE}
library("dplyr")
library("plyr")
library("foreach")
library("corrplot")
library("scales")
library("caret")
```
# Postoji li razlika u duljini zatvorske kazne s obzirom na razinu obrazovanja?

U tablici podataka imamo stupce "prison_years" i "education_level" <br>
"prison_years" poprima vrijednosti:
```{r}
for (v in unique(recidivism_full$Prison_Years)){
  print(v)
}
```
Imamo 4 klase duljine zatvorske kazne. <br>

"education_level" poprima vrijednosti:
```{r}
for (v in unique(recidivism_full$Education_Level)){
  print(v)
}
```
Vidimo da imamo 3 klase razine obrazovanja. <br><br>

Uz poznavanje jedinstvenih vrijednosti "education_level" i "prison_years" možemo pronaći kontingencijsku tablicu:
```{r}
contingency_table<-table(recidivism_full$Education_Level, recidivism_full$Prison_Years)
print(contingency_table)
```
Znajući kontingencijsku tablicu postavljamo hipoteze $H_0$ i $H_1$ <br>

$H_0:$ Proporcije zatvorenih za neku klasu iz "education_level" naspram ukupnog broja zatvorenih u nekoj klasi iz "prison_years" je jednak za svaku klasu iz "prison_years".  Drugim riječima:<br> <br>
Neka je $A = \text{"kontingencijska tablica"}$ i numerirajmo retke i stupce tablice A brojevima i={1,2,3} odnosno j={1,2,3,4}. <br>
Neka je $P_{ij} = \frac{A_{ij}}{\sum_{i=1}^{3} A_{ij}}$ (vidi ispis koda 5.)<br>
$H_0: p_{ij}=p_{ik} \  \forall i \in \{1,2,3\},\  \forall j,k \in \{1,2,3,4\}\  j \neq k$ <br>
$H_1: p_{ij}\neq p_{ik}\  ...$ <br>
Možemo testirati hipotezu $H_0\  \text{odnosno} \ H_1$ koristeći $\chi ^2$ test o jednakosti proporcija.
```{r}
chisq <- chisq.test(contingency_table)
chisq
```
Prikažimo reziduale pomoću "corrplot" paketa:
```{r}
corrplot(chisq$residuals, is.cor = FALSE)

```
<br>
Plava boja predstavlja asocijaciju tj. povezanost između retka i stupca. Uočimo da postoji pozitivna asocijacija ljudi sa završenim fakultetom i više od 3 godine kazne. Također postoji negativna asocijacija s ljudima sa završenim fakultetom i kaznom od 1-2 godine. <br>
Vidimo da je vrijednost testne statistike 223.12 i p-vrijednost $< 2.2 \times 10^{-16}$ što je značajno
manje od $p << \alpha = 0.05$. <br>
Dakle zaključujemo da **postoji razlika u duljini zatvorske kazne s obzirom na razinu obrazovanja!!**

# Jesu li mlađe dobne skupine podložnije ponavljanju kriminala od starijih?
označimo s $p_m$ i $p_s$ proporciju broja zatvorenika koji su ponovili kriminal i broja "starijih" odnosno "mlađih" zatvorenika.
U tablici jedino imamo "age_at_release" koji predstavlja dob u kojoj su pušteni na slobodu.
Po tome ćemo mjeriti starost.
```{r}
for (v in sort(unique(recidivism_full$Age_at_Release))){
  print(v)
}
```
Neka su "mlađi" svi do "33-37" isključivo. To nam daje ukupne populacije
```{r}
table <- count(recidivism_full$Age_at_Release)
mladi <- sum(table[1:3,"freq"])
stari <- sum(table[,"freq"])-mladi
print(table)
sprintf("Broj mladih je: %s",mladi)
sprintf("Broj starijih je: %s",stari)
```
Za mjeru ponovljenog kriminala koristit ćemo Recidivizam. <br>
Postoje 1 stupac u tablici koji nam govori je li je zatvorenik počinio zločin 3 godina nakon puštanja na slobodu i 3 stupca koja predstavljaju je li je uhićen u nekoj od te 3 godine. To su sve: Recidivism_Within_3years, Recidivism_Arrest_Year1, Recidivism_Arrest_Year2, Recidivism_Arrest_Year3. 0=no/1=yes<br>
Stoga možemo prebrojati sve one koji su ponovno počinili zločin.
```{r}
ponovljeni_mladi <- nrow(subset(recidivism_full,
                                Age_at_Release %in% c("18-22","23-27","28-32")
                                        & Recidivism_Within_3years))
ponovljeni_stari <- nrow(subset(recidivism_full,
                                Age_at_Release %in% c("33-37","38-42","43-47","48 or older") & Recidivism_Within_3years))
cat("Broj mladih/starih koji su ponovili zločin:",ponovljeni_mladi,ponovljeni_stari)

```
Poznavajuči brojeve možemo odrediti $p_s$ i $p_m$ i provesti test:
```{r}
Pm <- ponovljeni_mladi/mladi
Ps <- ponovljeni_stari/stari
rez <- prop.test(c(ponovljeni_mladi,ponovljeni_stari),c(mladi,stari), alternative="greater")
rez
rez$p.value
```
Dobivamo p-vrijednost $3.7478 \times 10^{-123}$ što je puno manje od nivoa značajnosti $\alpha = 0.05$. **Stoga odbacujemo nultu hipotezu u korist alternative i statistički zaključujemo uz značaj 0.05 da zatvorenici pušteni u svojoj "mladosti" skloniji ponavljanju kriminala.**

## Postoji li veza između korištene vrste narkotika i vrste zločina
U tablici podataka je zabilježeno 8 različitih zločina prije osude (Felony, Misdemeanor, Violent, Property, Drug, PPViolationCharges, DomesticViolenceCharges, GunCharges) i korištenje 4 narkotika (THC, Cocaine, Meth i ostali) nakon puštanja iz zatvora, podatke o korištenju prije nemamo.
Budući da su oznake zločina kategorijske (0, 1, 2 or more) koristit ćemo Pearsonov test korelacije ili $\chi^{2}$ test korelacije za odabrane parove zločina i korištenog narkotika. <br>
Korištenje narkotika se predstavlja u postotku pozitivnih testova 0-1. Te vrijednosti ćemo grupirati u 3 grupe. "Rijetko" ako je postotak <0.33, "Često" ako je postotak $\geq$ 0.33 i <0.66, te "Vrlo Često" ako je postotak $\geq$ 0.66. <br>
Za svaki kombinaciju zločina i korištenog narkotika formiramo hipoteze: <br>
$H_0$: Broj počinjenog kriminala je nezavisan postotku pozitivnih testova na neki narkotik. <br>
$H_1$: Ti brojevi nisu nezavisni. <br>
Pretvorimo kontinuirane podatke iz DrugTests u kategorijske:
```{r}
recidivism_full$CocaineUsage <- cut(recidivism_full$DrugTests_Cocaine_Positive,
                                    breaks=c(0,0.33,0.66,1),
                                    labels =c("Rijetko","Često","Vrlo Često"))
recidivism_full$MethUsage <- cut(recidivism_full$DrugTests_Meth_Positive,
                                 breaks =c(0,0.33,0.66,1),
                                 labels=c("Rijetko","Često","Vrlo Često"))
recidivism_full$THCUsage <- cut(recidivism_full$DrugTests_THC_Positive,
                                    breaks=c(0,0.33,0.66,1),
                                    labels=c("Rijetko","Često","Vrlo Često"))
recidivism_full$OtherUsage <- cut(recidivism_full$DrugTests_Other_Positive,
                                    breaks=c(0,0.33,0.66,1),
                                    labels=c("Rijetko","Često","Vrlo Često"))
```
Sada možemo provesti ukupno 4*8= 32 testa. <br>
```{r}
narkotici<- c("MethUsage","CocaineUsage","THCUsage","OtherUsage")
zlocin <- c("Prior_Conviction_Episodes_GunCharges",
                                        "Prior_Conviction_Episodes_Drug",
                                        "Prior_Conviction_Episodes_Viol",
                                        "Prior_Conviction_Episodes_Felony",
                                        "Prior_Conviction_Episodes_PPViolationCharges",
                                        "Prior_Conviction_Episodes_Misd",
                                        "Prior_Conviction_Episodes_DomesticViolenceCharges",
                                        "Prior_Conviction_Episodes_Prop")
chisq_tests <- data.frame(matrix(ncol=4, nrow=8),
                          row.names = zlocin)
colnames(chisq_tests)<- narkotici

for (narcotic in narkotici){
  for (crime in zlocin) {
    chisq <- chisq.test(table(recidivism_full[,narcotic],recidivism_full[, crime]),simulate.p.value = TRUE)
    chisq_tests[crime,narcotic]<-chisq$p.value
  }
}
```
```{r}
row.names(chisq_tests)<-c("GunCharges","Drug","Violent","Felony","PPViolationCharges","Misdemeanor","DomesticViolence","Property")
chisq_tests
```
Tablica iznad sadrži p-vrijednosti Pearsonovog $\chi^{2}$ testa. Za One kombinacije za koje je p vrijednost manja od 0.05 odbacujemo i odbacujemo nultu hipotezu o nezavisnosti kriminala i korištenog narkotika.
Uočimo par neočekivanih rezultata: <br>
Zatvorenici koji često konzumiraju THC odnosno produkte marihuane su zatvoreni zbog nasilja. Dok oni koji rijetko konzumiraju nisu. <br>

```{r}
chisq<-chisq.test(recidivism_full$Prior_Conviction_Episodes_Viol,recidivism_full$THCUsage,simulate.p.value = TRUE)
chisq
chisq$expected
chisq$observed
corrplot(chisq$residuals, is.corr = FALSE)
```
<br> Plavo označava da više zatvorenika od očekivanog koji često konzumiraju THC zatvoreno zbog nasilja. <br>
Pogledajmo kokain i "property":

```{r}
chisq<-chisq.test(recidivism_full$Prior_Conviction_Episodes_Prop,recidivism_full$CocaineUsage,simulate.p.value = TRUE)
corrplot(chisq$residuals, is.corr = FALSE)
```
<br> Zatvorenici koji nerijetko konzumiraju kokain su prije osude počinili nekoliko zločina vezanih uz nekretnine. <br>




## Jesu li mladi osuđenici skloniji drogama?

U tablici podataka koristeći postotak pozitivnih testova na različite droge možemo ispitati koja skupina zatvorenika je barem jednom koristila drogu u zatvoru. 



```{r}
mladi_droge <-  nrow(subset(recidivism_full, (DrugTests_THC_Positive!=0 | DrugTests_Meth_Positive!=0 | DrugTests_Cocaine_Positive!=0 | DrugTests_Cocaine_Positive!=0) & Age_at_Release %in% c("18-22","23-27","28-32")))

stari_droge <- nrow(subset(recidivism_full, (DrugTests_THC_Positive!=0 | DrugTests_Meth_Positive!=0 | DrugTests_Cocaine_Positive!=0 | DrugTests_Cocaine_Positive!=0) & Age_at_Release %in% c("33-37","38-42","43-47","48 or older")))

cat("Broj mladih/starih koji su skloni drogama:",mladi_droge,stari_droge)


```
Vidimo da veći broj mlađih zatvorenika koristi drogu iako ih je manje od starijih u tablici
```{r}
Dm <- mladi_droge/mladi
Ds <- stari_droge/stari
rez <- prop.test(c(4670,3612),c(12224,13611), alternative="greater")
rez
rez$p.value
```

Dobivamo p-vrijednost $1.069374 \times 10^{-89}$ što je manje od nivoa značajnosti $\alpha = 0.05$. **Stoga odbacujemo nultu hipotezu u korist alternative i statistički zaključujemo uz značaj 0.05 da su mlađi zatvorenici skloniji drogama**
```{r}
stari_drogerasi <- recidivism_full %>%
  select(DrugTests_THC_Positive, DrugTests_Meth_Positive, DrugTests_Cocaine_Positive, DrugTests_Other_Positive, Age_at_Release) %>%
  filter((DrugTests_THC_Positive!=0 | DrugTests_Meth_Positive!=0 | DrugTests_Cocaine_Positive!=0 | DrugTests_Cocaine_Positive!=0) & Age_at_Release %in% c("33-37","38-42","43-47","48 or older") ) %>%
  filter(rowSums(.[,1:4]) > 0) %>% na.omit()


mladi_drogerasi <- recidivism_full %>%
  select(DrugTests_THC_Positive, DrugTests_Meth_Positive, DrugTests_Cocaine_Positive, DrugTests_Other_Positive, Age_at_Release) %>%
  filter((DrugTests_THC_Positive!=0 | DrugTests_Meth_Positive!=0 | DrugTests_Cocaine_Positive!=0 | DrugTests_Cocaine_Positive!=0) & Age_at_Release %in% c("18-22","23-27","28-32") ) %>%
  filter(rowSums(.[,1:4]) > 0) %>% na.omit()


stari_drogerasi <- stari_drogerasi %>%
  mutate(total = rowSums(.[1:4])/4) %>%
  select(-DrugTests_THC_Positive,-DrugTests_Meth_Positive,-DrugTests_Cocaine_Positive,-DrugTests_Other_Positive)

mladi_drogerasi <- mladi_drogerasi %>%
  mutate(total = rowSums(.[1:4])/4) %>%
  select(-DrugTests_THC_Positive,-DrugTests_Meth_Positive,-DrugTests_Cocaine_Positive,-DrugTests_Other_Positive)

```


```{r}
hist(mladi_drogerasi$total)
hist(stari_drogerasi$total)
```

```{r}
stari_drogerasi_sqrt <- stari_drogerasi %>%
  mutate(total_sqrt = total^(1/3.5))

mladi_drogerasi_sqrt <- mladi_drogerasi %>%
        mutate(total_sqrt = total^(1/3.5))

hist(stari_drogerasi_sqrt$total_sqrt)
hist(mladi_drogerasi_sqrt$total_sqrt)
```

```{r}
boxplot(stari_drogerasi_sqrt$total_sqrt, mladi_drogerasi_sqrt$total_sqrt )

```

```{r}
qqnorm(mladi_drogerasi_sqrt$total_sqrt)
qqline(mladi_drogerasi_sqrt$total_sqrt)
```

Pozivamo se na robusnost T-testa.
```{r}
var.test(mladi_drogerasi_sqrt$total_sqrt,stari_drogerasi_sqrt$total_sqrt)
```

```{r}
t.test(mladi_drogerasi_sqrt$total_sqrt, stari_drogerasi_sqrt$total_sqrt, alternative = "greater", var.equal=FALSE)
```
```{r}
train_test <- subset(recidivism_full, Training_Sample==1)
test_sample <- subset(recidivism_full, Training_Sample!=1)
```
```{r}
model <- glm(Recidivism_Within_3years ~ Gender + Race + Education_Level
             , data = train_test, family="binomial")
summary(model)
```
```{r}
probabilities <- predict(model, newdata = test_sample, type="response")
predicted.classes <- ifelse(probabilities > 0.5, TRUE, FALSE)
accuracy <- mean(predicted.classes == test_sample$Recidivism_Within_3years)
print(accuracy)

```

```{r}
model <- glm(Recidivism_Within_3years ~ Violations_ElectronicMonitoring + Violations_Instruction + Violations_FailToReport + Violations_MoveWithoutPermission
             , data = train_test, family="binomial")
probabilities <- predict(model, newdata = test_sample, type="response")
predicted.classes <- ifelse(probabilities > 0.5, TRUE, FALSE)
accuracy <- mean(predicted.classes == test_sample$Recidivism_Within_3years)
print(accuracy)
```

```{r}
model <- glm(Recidivism_Within_3years ~ Condition_MH_SA + Condition_Cog_Ed + Condition_Other
             , data = train_test, family="binomial")
probabilities <- predict(model, newdata = test_sample, type="response")
predicted.classes <- ifelse(probabilities > 0.5, TRUE, FALSE)
accuracy <- mean(predicted.classes == test_sample$Recidivism_Within_3years)
print(accuracy)

```

```{r}
model <- glm(Recidivism_Within_3years ~ Education_Level + Dependents
             , data = train_test, family="binomial")
probabilities <- predict(model, newdata = test_sample, type="response")
predicted.classes <- ifelse(probabilities > 0.5, TRUE, FALSE)
accuracy <- mean(predicted.classes == test_sample$Recidivism_Within_3years)
print(accuracy)
```
```{r}
model <- glm(Recidivism_Within_3years ~ Prior_Arrest_Episodes_Violent + Prior_Arrest_Episodes_PPViolationCharges
             , data = train_test, family="binomial")
probabilities <- predict(model, newdata = test_sample, type="response")
predicted.classes <- ifelse(probabilities > 0.5, TRUE, FALSE) %>% na.omit()
accuracy <- mean(predicted.classes == test_sample$Recidivism_Within_3years)
print(accuracy)

```
```{r}
model <- glm(Recidivism_Within_3years ~ Gender + Race
             , data = train_test, family="binomial")
probabilities <- predict(model, newdata = test_sample, type="response")
predicted.classes <- ifelse(probabilities > 0.5, TRUE, FALSE) %>% na.omit()
accuracy <- mean(predicted.classes == test_sample$Recidivism_Within_3years)
print(accuracy)
```
